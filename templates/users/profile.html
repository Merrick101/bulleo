{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container mt-5 profile-page-container">
    <h2 class="mb-4">{% trans "Profile Settings" %}</h2>

    <div class="row">
        <!-- Profile Info Section (Left Side) -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm profile-info-card">
                <div class="card-body">
                    <h5 class="card-title profile-username">{{ profile.user.username }}</h5>
                    <p class="card-text profile-bio">{{ profile.bio }}</p>
                    
                    <!-- Profile Picture Section -->
                    <div class="profile-picture-section" id="profile-picture-section">
                        {% if profile.profile_picture %}
                            <img src="{{ profile.profile_picture.url }}" alt="{% trans 'Profile Picture' %}" class="profile-picture" id="profile-picture">
                        {% else %}
                            <p class="no-profile-picture">{% trans "No profile picture uploaded." %}</p>
                        {% endif %}
                        
                        <!-- Form for Profile Picture Upload -->
                        <form method="POST" enctype="multipart/form-data" id="profile-picture-form">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label" for="profile-picture-upload">{% trans "Change Profile Picture" %}</label>
                                <input 
                                    type="file" 
                                    class="form-control profile-picture-input" 
                                    name="profile_picture" 
                                    accept="image/*" 
                                    id="profile-picture-upload"
                                >
                            </div>
                            <button type="submit" class="btn btn-primary" id="upload-picture-btn">
                                {% trans "Upload Picture" %}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Menu Section (Right Side) -->
        <div class="col-md-8">
            <div class="accordion" id="profileAccordion">
                
                <!-- Edit Account Details Section -->
                <div class="accordion-item" id="edit-account-section">
                    <h2 class="accordion-header" id="headingAccount">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAccount" aria-expanded="true" aria-controls="collapseAccount">
                            {% trans "Edit Account Details" %}
                        </button>
                    </h2>
                    <div id="collapseAccount" class="accordion-collapse collapse show" aria-labelledby="headingAccount" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <!-- Username Update Mini-Form -->
                            <form method="POST" id="update-username-form" action="{% url 'users:update_username' %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="account_username">
                                <div class="mb-3">
                                    <label for="username_field" class="form-label">{% trans "Username" %}</label>
                                    <input type="text" class="form-control profile-username-update-input" id="username_field" name="username" value="{{ profile.user.username }}" placeholder="Enter new username">
                                </div>
                                <button type="submit" class="btn btn-primary profile-username-save-btn">{% trans "Save Username" %}</button>
                                <div id="username-feedback"></div>
                            </form>

                            <!-- Email Update Mini-Form -->
                            <form method="POST" id="update-email-form" action="{% url 'users:update_email' %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="account_email">
                                <div class="mb-3">
                                    <label for="email_field" class="form-label">{% trans "Email" %}</label>
                                    <input type="email" class="form-control profile-email-update-input" id="email_field" name="email" value="{{ profile.user.email }}" placeholder="Enter new email">
                                </div>
                                <button type="submit" class="btn btn-primary profile-email-save-btn">{% trans "Save Email" %}</button>
                                <div id="email-feedback"></div>
                            </form>

                            <!-- Password Update Mini-Form -->
                            <form method="POST" id="update-password-form" action="{% url 'users:update_password' %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="account_password">
                                <div class="mb-3">
                                    <label for="current_password_field" class="form-label">{% trans "Current Password" %}</label>
                                    <input type="password" class="form-control profile-current-password-input" id="current_password_field" name="current_password" placeholder="Enter current password">
                                </div>
                                <div class="mb-3">
                                    <label for="new_password_field" class="form-label">{% trans "New Password" %}</label>
                                    <input type="password" class="form-control profile-new-password-input" id="new_password_field" name="new_password" placeholder="Enter new password">
                                </div>
                                <div class="mb-3">
                                    <label for="confirm_new_password_field" class="form-label">{% trans "Confirm New Password" %}</label>
                                    <input type="password" class="form-control profile-confirm-new-password-input" id="confirm_new_password_field" name="confirm_new_password" placeholder="Confirm new password">
                                </div>
                                <p class="text-muted">Leave password fields blank if you do not wish to change your password.</p>
                                <button type="submit" class="btn btn-primary profile-password-save-btn">{% trans "Save Password" %}</button>
                                <div id="password-feedback"></div>
                            </form>

                            <!-- Notification Preferences Update Mini-Form -->
                            <form method="POST" id="update-notifications-form" action="{% url 'users:update_notifications' %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="account_notifications">
                                <div class="mb-3">
                                    <label class="form-label" for="notification_preferences_field">{% trans "Notifications" %}</label>
                                    <label class="switch ms-2">
                                        <input type="checkbox" name="notification_preferences" id="notification_preferences_field" {% if profile.notifications_enabled %} checked {% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary profile-notifications-save-btn">{% trans "Save Notifications" %}</button>
                                <div id="notifications-feedback"></div>
                            </form>

                            <!-- Global Reset Button -->
                            <button type="button" class="btn btn-warning profile-reset-all-btn" id="reset-account-changes-btn">{% trans "Reset to Default" %}</button>
                        </div>
                    </div>
                </div>


                <!-- News Feed Preferences Section -->
                <div class="accordion-item" id="news-feed-preferences-section">
                    <h2 class="accordion-header" id="headingNewsFeed">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNewsFeed" aria-expanded="false" aria-controls="collapseNewsFeed">
                            {% trans "News Feed Preferences" %}
                        </button>
                    </h2>
                    <div id="collapseNewsFeed" class="accordion-collapse collapse" aria-labelledby="headingNewsFeed" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <form method="POST" id="news-feed-preferences-form">
                                {% csrf_token %}
                                <!-- Hidden field to identify this form -->
                                <input type="hidden" name="form_type" value="preferences">
                                
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Preferred Categories" %}</label><br>
                                    <!-- Using context variable 'preferred_category_names' to check selections -->
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="world_news" id="world_news" {% if 'World News' in preferred_category_names %} checked {% endif %}>
                                        <label class="form-check-label" for="world_news"><i class="fas fa-globe"></i> {% trans "World News" %}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="politics" id="politics" {% if 'Politics' in preferred_category_names %} checked {% endif %}>
                                        <label class="form-check-label" for="politics"><i class="fas fa-flag"></i> {% trans "Politics" %}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="business" id="business" {% if 'Business' in preferred_category_names %} checked {% endif %}>
                                        <label class="form-check-label" for="business"><i class="fas fa-briefcase"></i> {% trans "Business" %}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="technology" id="technology" {% if 'Technology' in preferred_category_names %} checked {% endif %}>
                                        <label class="form-check-label" for="technology"><i class="fas fa-laptop"></i> {% trans "Technology" %}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sports" id="sports" {% if 'Sports' in preferred_category_names %} checked {% endif %}>
                                        <label class="form-check-label" for="sports"><i class="fas fa-basketball-ball"></i> {% trans "Sports" %}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="entertainment" id="entertainment" {% if 'Entertainment' in preferred_category_names %} checked {% endif %}>
                                        <label class="form-check-label" for="entertainment"><i class="fas fa-tv"></i> {% trans "Entertainment" %}</label>
                                    </div>
                                </div>

                                <div class="d-flex gap-2 mt-3">
                                    <button type="submit" class="btn btn-primary" id="save-preferences-btn">{% trans "Save Preferences" %}</button>
                                    <button type="button" class="btn btn-warning" id="reset-preferences-btn">{% trans "Reset to Default" %}</button>
                                    <button type="button" class="btn btn-secondary" id="cancel-preferences-btn">{% trans "Cancel Changes" %}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Saved for Later Section -->
                <div class="accordion-item" id="saved-for-later-section">
                    <h2 class="accordion-header" id="headingSaved">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSaved" aria-expanded="false" aria-controls="collapseSaved">
                            {% trans "Saved for Later" %}
                        </button>
                    </h2>
                    <div id="collapseSaved" class="accordion-collapse collapse" aria-labelledby="headingSaved" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <ul id="saved-articles-list" class="list-unstyled">
                                {% for article in saved_articles %}
                                    <li class="d-flex align-items-center mb-2">
                                        <img 
                                            src="{{ article.thumbnail.url }}" 
                                            alt="Article Thumbnail" 
                                            style="width: 50px; height: 50px; object-fit: cover;" 
                                            class="me-2"
                                        >
                                        <a href="{{ article.get_absolute_url }}">{{ article.title }}</a>
                                        <button class="btn btn-sm btn-danger ms-auto" id="remove-saved-{{ article.id }}">
                                            {% trans "Remove" %}
                                        </button>
                                    </li>
                                {% empty %}
                                    <p class="text-muted">{% trans "No saved articles." %}</p>
                                {% endfor %}
                            </ul>
                            <button class="btn btn-danger" id="clear-saved-articles-btn">{% trans "Clear All" %}</button>
                        </div>
                    </div>
                </div>

                <!-- Upvoted Articles Section -->
                <div class="accordion-item" id="upvoted-articles-section">
                    <h2 class="accordion-header" id="headingUpvoted">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpvoted" aria-expanded="false" aria-controls="collapseUpvoted">
                            {% trans "Upvoted Articles" %}
                        </button>
                    </h2>
                    <div id="collapseUpvoted" class="accordion-collapse collapse" aria-labelledby="headingUpvoted" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <ul id="upvoted-articles-list" class="list-unstyled">
                                {% for article in upvoted_articles %}
                                    <li class="d-flex align-items-center mb-2">
                                        <img 
                                            src="{{ article.thumbnail.url }}" 
                                            alt="Article Thumbnail" 
                                            style="width: 50px; height: 50px; object-fit: cover;" 
                                            class="me-2"
                                        >
                                        <a href="{{ article.get_absolute_url }}">{{ article.title }}</a>
                                        <button class="btn btn-sm btn-danger ms-auto" id="remove-upvote-{{ article.id }}">
                                            {% trans "Remove" %}
                                        </button>
                                    </li>
                                {% empty %}
                                    <p class="text-muted">{% trans "No upvoted articles." %}</p>
                                {% endfor %}
                            </ul>
                            <button class="btn btn-danger" id="clear-upvoted-articles-btn">{% trans "Clear All" %}</button>
                        </div>
                    </div>
                </div>

                <!-- Downvoted Articles Section -->
                <div class="accordion-item" id="downvoted-articles-section">
                    <h2 class="accordion-header" id="headingDownvoted">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDownvoted" aria-expanded="false" aria-controls="collapseDownvoted">
                            {% trans "Downvoted Articles" %}
                        </button>
                    </h2>
                    <div id="collapseDownvoted" class="accordion-collapse collapse" aria-labelledby="headingDownvoted" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <ul id="downvoted-articles-list" class="list-unstyled">
                                {% for article in downvoted_articles %}
                                    <li class="d-flex align-items-center mb-2">
                                        <img 
                                            src="{{ article.thumbnail.url }}" 
                                            alt="Article Thumbnail" 
                                            style="width: 50px; height: 50px; object-fit: cover;" 
                                            class="me-2"
                                        >
                                        <a href="{{ article.get_absolute_url }}">{{ article.title }}</a>
                                        <button class="btn btn-sm btn-danger ms-auto" id="remove-downvote-{{ article.id }}">
                                            {% trans "Remove" %}
                                        </button>
                                    </li>
                                {% empty %}
                                    <p class="text-muted">{% trans "No downvoted articles." %}</p>
                                {% endfor %}
                            </ul>
                            <button class="btn btn-danger" id="clear-downvoted-articles-btn">{% trans "Clear All" %}</button>
                        </div>
                    </div>
                </div>

                <!-- Comment History Section -->
                <div class="accordion-item" id="comment-history-section">
                    <h2 class="accordion-header" id="headingComments">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseComments" aria-expanded="false" aria-controls="collapseComments">
                            {% trans "Comment History" %}
                        </button>
                    </h2>
                    <div id="collapseComments" class="accordion-collapse collapse" aria-labelledby="headingComments" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <ul id="comment-history-list" class="list-unstyled">
                                {% for comment in comments %}
                                    <li class="mb-3">
                                        <div class="d-flex align-items-center">
                                            <img 
                                                src="{{ comment.article.thumbnail.url }}" 
                                                alt="Article Thumbnail" 
                                                style="width: 50px; height: 50px; object-fit: cover;" 
                                                class="me-2"
                                            >
                                            <a href="{{ comment.article.get_absolute_url }}">{{ comment.article.title }}</a>
                                        </div>
                                        <p class="ms-5 mt-2">{{ comment.content }}</p>
                                        <div class="ms-5">
                                            <button class="btn btn-sm btn-warning" id="edit-comment-{{ comment.id }}">
                                                {% trans "Edit" %}
                                            </button>
                                            <button class="btn btn-sm btn-danger" id="remove-comment-{{ comment.id }}">
                                                {% trans "Remove" %}
                                            </button>
                                        </div>
                                    </li>
                                {% empty %}
                                    <p class="text-muted">{% trans "No comments yet." %}</p>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Delete Account Section -->
                <div class="accordion-item" id="delete-account-section">
                    <h2 class="accordion-header" id="headingDelete">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDelete" aria-expanded="false" aria-controls="collapseDelete">
                            {% trans "Delete Account" %}
                        </button>
                    </h2>
                    <div id="collapseDelete" class="accordion-collapse collapse" aria-labelledby="headingDelete" data-bs-parent="#profileAccordion">
                        <div class="accordion-body">
                            <p class="text-danger">{% trans "Warning: Deleting your account is irreversible. All data will be lost." %}</p>
                            <form method="POST" id="delete-account-form">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="password" class="form-label">{% trans "Enter Password" %}</label>
                                    <input type="password" name="password" id="password" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm_password" class="form-label">{% trans "Confirm Password" %}</label>
                                    <input type="password" name="confirm_password" id="confirm_password" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-danger" id="confirm-deletion-btn">{% trans "Confirm Account Deletion" %}</button>
                                <button type="button" class="btn btn-secondary" id="cancel-deletion-btn">{% trans "Cancel" %}</button>
                            </form>
                        </div>
                    </div>
                </div>

            </div> <!-- End of accordion -->
        </div> <!-- End of col-md-8 -->
    </div> <!-- End of row -->
</div>
{% block extra_js %}
<script src="{% static 'js/profile.js' %}"></script>
{% endblock extra_js %}
{% endblock %}
